<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>장독대 필름</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>
    <script src="/js/header.js"></script>

    <style>
        /* 프로필 이미지 스타일 */
        .box {
            width: 150px;
            height: 150px;
            border-radius: 70%;
            overflow: hidden;
        }

        .profile {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* 탭 스타일 */
        .tab_item {
            width: calc(100% / 10);
            height: 50px;
            background-color: #f8f8f8;
            line-height: 50px;
            font-size: 15px;
            text-align: center;
            color: #333333;
            display: block;
            float: left;
            text-align: center;
            font-weight: bold;
            transition: all 0.2s ease;
        }

        .tab_item:hover {
            opacity: 0.75;
        }

        /* 라디오 버튼 UI 삭제*/
        input[name="tab_item"] {
            display: none;
        }

        /* 탭 컨텐츠 스타일 */
        .tab_content {
            display: none;
            padding: 40px 40px 0;
            clear: both;
            overflow: hidden;
        }

        /* 선택 된 탭 콘텐츠를 표시 */
        #all:checked ~ #all_content,
        #programming:checked ~ #programming_content,
        #design:checked ~ #design_content {
            display: block;
        }


        /*선택된 탭 스타일 */
        .tabs input:checked + .tab_item {
            font-weight: bold;
            font-size: 18px;
        }

        .nav {
            --bs-nav-tabs-border-width: 0px;
            --bs-nav-tabs-link-active-border-color: #000;
            border-bottom: 1px solid var(--bs-nav-tabs-border-color);
        }

        .nav-link,
        .nav-link:hover,
        .nav-link:focus {
            color: gray;
        }

        .nav .nav-link.active,
        .nav .nav-item.show .nav-link {
            border-bottom: 2px solid black;
            color: black;
            font-weight: bold;
        }

    </style>

    <script>
        $(document).ready(function () {
            // 닉네임 중복 확인
            let confirmName = false;
            $("#confirmName").on("click", function () {
                const name = $("#user-name").val();
                $.ajax({
                    type: "get",
                    url: "/confirmName",
                    data: {name: name},
                    success: function (data) {
                        if (data === 1) {
                            $("#nameCheckMessage").text("이미 존재하는 닉네임입니다..");
                        } else {
                            $("#nameCheckMessage").text("사용 가능한 닉네임입니다.");
                            $("#confirmName").attr("type", "submit");
                            confirmName = true;
                        }
                    },
                    error: function () {
                        alert("통신 실패");
                    }
                })
            })

            let confirmPw = false;
            let nowPwCheck = false;
            let pwCheck = false;
            let newPwCheck = false;
            let userNameCheck = false;
            let same = false;

            // 수정 및 유효성 검증
            $("#change").on("click", function () {
                const pw = $("#user-pw").val();
                const userPw = $("#user-pw").val();
                const newPw = $("#user-new-pw").val();
                const pwck = $("#user-pw-check").val();
                const userName = $("#user-name").val();
                const userNewName = $("#user-new-name").val();
                $.ajax({
                    type: "get",
                    url: "/confirmPw",
                    data: {pw: pw},
                    success: function (data) {
                        if (data === 1) {
                            confirmPw = true;
                            if (userPw == null || userPw == "") {
                                alert("기존 비밀번호를 입력하세요");
                                return;
                            } else {
                                nowPwCheck = true;
                            }

                            if (newPw == null || newPw == "") {
                                alert("새 비밀번호를 입력하세요")
                                return;
                            } else {
                                pwCheck = true;
                            }

                            if (pwck == null || pwck == "") {
                                alert("새 비밀번호를 한번 더 입력하세요");
                                return;
                            } else {
                                newPwCheck = true;
                            }

                            if (newPw != pwck) {
                                alert("비밀번호가 일치하지 않습니다.");
                                return;
                            } else {
                                same = true;
                            }

                            if ((confirmPw && nowPwCheck && pwCheck && newPwCheck && same && confirmName) || (confirmPw && nowPwCheck && pwCheck && newPwCheck && same) || (confirmPw && nowPwCheck && confirmName)) {
                                const pw = $("#user-new-pw").val();
                                const userName = $("#user-name").val();
                                const id = $("#id").val();
                                $.ajax({
                                    url: 'myPage/' + id,
                                    type: 'POST',
                                    data: {
                                        pw: pw,
                                        name: userName
                                    },
                                    success: function (data) {
                                        alert(data)
                                        if (data == "success") {
                                            location.reload();
                                        }
                                    },
                                    error: function () {
                                        alert("변경 실패")
                                    }
                                })
                                form.submit();
                            } else {
                            }

                        } else {
                            alert("기존 비밀번호와 다릅니다.");
                        }
                    },
                    error: function () {
                        alert("현재 비밀번호를 입력하세요");
                    }
                })
            })

            $("i").on("click", function () {
                const id = $(this).attr('id').slice(0, -1);
                const data = {idx: id}

                if ($(this).hasClass("bi-heart") === true) {
                    $.ajax({
                        url: "/movie/recoms/like",
                        type: "GET",
                        data: data,
                        success: (result) => {
                            if (result == 1) {
                                $.ajax({
                                    url: "/movie/recoms/like",
                                    type: "PUT",
                                    data: data,
                                    success: () => {
                                        $(this).removeClass("bi-heart").addClass("bi-heart-fill");
                                    },
                                    error: () => {
                                    }
                                });
                            } else {
                                $.ajax({
                                    url: "/movie/recoms/like",
                                    type: "POST",
                                    data: data,
                                    success: () => {
                                        $(this).removeClass("bi-heart").addClass("bi-heart-fill");
                                    },
                                    error: () => {
                                    }
                                });
                            }
                        },
                        error: () => {
                        }
                    });
                } else {
                    //제거 update
                    $.ajax({
                        url: "/movie/recoms/like",
                        type: "DELETE",
                        data: data,
                        success: () => {
                            $(this).removeClass("bi-heart-fill").addClass("bi-heart");
                        },
                        error: () => {
                        }
                    });
                }

            });

            $(document).on("click", "img", function () {

                location.href = "/movie/recom/" + $(this).attr('id');
            });

        })
    </script>

</head>
<body>
<header th:replace="~{layout/header :: header-basic}"></header>
<main class="container">
    <!--  사이드 바-->
    <div class="row">
        <div class="col-sm-2 mt-5 pt-5">
            <div class="mt-5">
                <!--프로필 이미지-->
                <div class="box mx-auto" style="background: #BDBDBD;">
                    <a href="#"><img class="profile" src="/images/squirrel.jpg"></a>
                </div>
                <div>
                    <h6 class="my-3 px-2 text-center text-secondary fw-bold" th:text="${session.userName}"></a></h6>
                </div>

                <!--       내가 쓴 글/댓글 탭 바-->
                <ul class="nav flex-column text-center" id="tabs" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" href="#my-page-board" data-bs-toggle="tab">내 커뮤니티 글</a>
                    </li>

                    <!--       나만의 영화공간 탭 바-->
                    <li class="nav-item">
                        <a class="nav-link" href="#my-page-movie" data-bs-toggle="tab">나만의 영화공간</a>
                    </li>
                    <li class="nav-item">

                        <!--  정보수정 모달 창  -->
                        <button type="button" class="btn btn-light text-primary"
                                data-bs-toggle="modal" data-bs-target="#changeModal"
                                style="background: none; outline:none; box-shadow:none;">내 정보 수정
                        </button>
                    </li>
                    <div class="modal fade" id="changeModal">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h1 class="modal-title">회원정보 수정</h1>
                                </div>
                                <div class="modal-body">
                                    <form method="post">
                                        <div class="col-sm form-floating">
                                            <div class="box mx-auto" style="background: #BDBDBD;">
                                                <a href="#"><img class="profile" src="/images/squirrel.jpg"></a>
                                            </div>
                                            <div>
                                                <h6 class="my-3 px-2 text-center text-secondary fw-bold"
                                                    th:text="${session.userName}"></h6>
                                                <input type="hidden" id="id" th:value="${session.id}">
                                            </div>
                                            <div class="input-group">
                                                <span class="input-group-text fw-bold">PW 변경</span>
                                            </div>
                                            <div class="col-sm form-floating">
                                                <input type="text" class="form-control" id="user-pw" name="userPw"
                                                       placeholder="비밀번호">
                                                <label for="user-pw">기존 비밀번호를 입력(필수)</label>
                                            </div>
                                            <div class="col-sm form-floating">
                                                <input type="text" class="form-control" id="user-new-pw"
                                                       name="userNewPw" placeholder="비밀번호">
                                                <label for="user-pw">새 비밀번호를 입력(선택)</label>
                                            </div>
                                        </div>
                                        <div class="form-floating">
                                            <input type="text" class="form-control" id="user-pw-check"
                                                   name="userPwCheck"
                                                   placeholder="비밀번호 확인">
                                            <label for="user-pw-check">새 비밀번호를 한번 더 입력</label>
                                        </div>

                                        <div class="col-sm form-floating  my-4">
                                            <div class="input-group">
                                                <span class="input-group-text fw-bold">닉네임 변경</span>
                                            </div>
                                            <div class="col-sm form-floating text-start">
                                                <input type="text" class="form-control" id="user-name" name="userName"
                                                       placeholder="닉네임">
                                                <label for="user-name">새 닉네임을 입력(선택)</label>
                                                <button type="button" class="btn btn-outline-success mt-2"
                                                        id="confirmName">중복확인
                                                </button>
                                                <span id="nameCheckMessage"></span>
                                            </div>
                                        </div>
                                        <div class="d-grid gap-3">
                                            <button type="button" class=" btn btn-primary fw-bold p-2 d-grid gap-3">
                                                수정하기
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!--          문의하기 탭 바-->
                    <li class="nav-item">
                        <a class="nav-link" href="/qnaList">문의하기</a>
                    </li>
                </ul>
            </div>

        </div>

        <!--   내 커뮤니티 글(탭바)-->
        <div class="col-sm p-3">
            <div class="tab-content">
                <div id="my-page-board" class="tab-pane active">
                    <div th:replace="~{mypage/myBoard :: myBoard}"/>
                </div>
                <div id="my-page-movie" class="tab-pane">
                    <div th:replace="~{mypage/myMovie :: myMovie}"/>
                </div>
            </div>
        </div>
        <div class="col-sm-2"></div>
    </div>

    </div>
</main>

<footer th:replace="~{layout/footer :: footer-basic}"></footer>
</body>
</html>